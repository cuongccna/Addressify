// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
  schemas  = ["public"]
}

// User model - Authentication managed by Prisma
model User {
  id                    String   @id @default(uuid())
  email                 String   @unique
  password              String   // Hashed password
  name                  String?
  emailVerified         Boolean  @default(false)
  notificationSettings  Json     @default("{\"quoteGenerated\": false, \"dailySummary\": false, \"weeklySummary\": true, \"priceAlerts\": true, \"failedQuotes\": true}")
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  
  shops                 Shop[]
  emailLogs             EmailLog[]
  apiKeys               ApiKey[]
  webhooks              Webhook[]
  sessions              Session[]
  
  @@map("addressify_users")
  @@schema("public")
}

// Session model for authentication
model Session {
  id        String   @id @default(uuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())
  
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([token])
  @@index([userId])
  @@map("addressify_sessions")
  @@schema("public")
}

// Shop model - each user can have multiple shops
model Shop {
  id              String   @id @default(uuid())
  name            String
  userId          String
  
  // Sender address configuration (linh hoạt cho cả địa chỉ cũ và mới)
  senderAddress   String   // Số nhà, tên đường
  senderWard      String?  // Phường/Xã (có thể null với địa chỉ mới)
  senderDistrict  String   // Quận/Huyện hoặc Phường/Xã (địa chỉ mới)
  senderProvince  String   // Tỉnh/Thành phố
  
  // GHN configuration (Giao Hàng Nhanh)
  ghnProvinceId   String?
  ghnDistrictId   String?
  ghnWardCode     String?
  ghnShopId       String?
  
  // GHTK configuration (Giao Hàng Tiết Kiệm)
  ghtkPickAddress String?
  ghtkPickProvince String?
  ghtkPickDistrict String?
  ghtkPickWard    String?
  ghtkPartnerId   String?  // Partner ID/Shop ID của GHTK
  
  // VTP configuration (Viettel Post)
  vtpProvinceId   String?
  vtpDistrictId   String?
  vtpWardId       String?
  vtpCustomerId   String?  // Mã khách hàng VTP
  vtpGroupId      String?  // Mã nhóm địa chỉ
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  quoteHistories  QuoteHistory[]
  
  @@index([userId])
  @@map("addressify_shops")
  @@schema("public")
}

// Quote history - track all bulk quote requests
model QuoteHistory {
  id                String   @id @default(uuid())
  shopId            String
  
  // Address information
  recipientName     String
  recipientPhone    String
  recipientAddress  String
  normalizedAddress String
  province          String
  district          String
  ward              String
  wardCode          String?
  confidence        Float
  
  // Quote results (JSON)
  quotes            Json     // Array of {provider: string, service: string, amount: number, currency: string}
  
  // Metadata
  weight            Int      @default(1000) // grams
  value             Int      @default(0)    // VND
  note              String?
  
  createdAt         DateTime @default(now())
  
  shop              Shop     @relation(fields: [shopId], references: [id], onDelete: Cascade)
  
  @@index([shopId, createdAt])
  @@map("addressify_quote_histories")
  @@schema("public")
}

// Email log - track all sent emails
model EmailLog {
  id        String   @id @default(cuid())
  userId    String
  type      String   // "quote_generated", "daily_summary", "weekly_summary", "price_alert", "failed_quote", "welcome"
  to        String
  subject   String
  status    String   // "sent", "failed", "pending"
  error     String?
  sentAt    DateTime @default(now())
  
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([type])
  @@index([sentAt])
  @@map("addressify_email_logs")
  @@schema("public")
}

// API Key - for external integrations
model ApiKey {
  id          String   @id @default(cuid())
  userId      String
  name        String
  key         String   @unique
  keyPrefix   String   // "addr_live" or "addr_test"
  permissions Json     @default("[]") // ["quotes:read", "quotes:create", "shops:read"]
  lastUsedAt  DateTime?
  expiresAt   DateTime?
  isActive    Boolean  @default(true)
  rateLimit   Int      @default(100) // requests per minute
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  usage       ApiKeyUsage[]
  
  @@index([userId])
  @@index([key])
  @@map("addressify_api_keys")
  @@schema("public")
}

// API Key Usage - track API key usage
model ApiKeyUsage {
  id            String   @id @default(cuid())
  apiKeyId      String
  endpoint      String
  method        String
  statusCode    Int
  responseTime  Int      // milliseconds
  ipAddress     String?
  userAgent     String?
  timestamp     DateTime @default(now())
  
  apiKey        ApiKey   @relation(fields: [apiKeyId], references: [id], onDelete: Cascade)
  
  @@index([apiKeyId])
  @@index([timestamp])
  @@map("addressify_api_key_usage")
  @@schema("public")
}

// Webhook - user-defined webhooks
model Webhook {
  id        String   @id @default(cuid())
  userId    String
  url       String
  events    String[] // ["quote.created", "shop.created", "bulk_quote.completed"]
  secret    String   // For HMAC signature
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  logs      WebhookLog[]
  
  @@index([userId])
  @@map("addressify_webhooks")
  @@schema("public")
}

// Webhook Log - track webhook deliveries
model WebhookLog {
  id           String   @id @default(cuid())
  webhookId    String
  event        String   // "quote.created"
  payload      Json
  response     Json?
  statusCode   Int?
  attempt      Int      @default(1)
  success      Boolean  @default(false)
  error        String?
  responseTime Int?     // Response time in milliseconds
  timestamp    DateTime @default(now())
  
  webhook     Webhook  @relation(fields: [webhookId], references: [id], onDelete: Cascade)
  
  @@index([webhookId])
  @@index([timestamp])
  @@map("addressify_webhook_logs")
  @@schema("public")
}

// ==================== MASTER DATA TABLES ====================

// Province/City master data
model Province {
  id             String   @id @default(cuid())
  name           String   // Tên tỉnh/thành phố
  code           String?  // Mã vùng
  
  // Provider IDs
  ghnId          Int?     @unique // GHN ProvinceID
  ghtkId         String?  // GHTK province code
  vtpId          String?  // Viettel Post province ID
  
  // Name variations for fuzzy matching
  nameExtensions String[] // ["Hồ Chí Minh", "TP.HCM", "TPHCM", "Sài Gòn", ...]
  
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  
  districts      District[]
  
  @@index([name])
  @@index([ghnId])
  @@map("addressify_provinces")
  @@schema("public")
}

// District master data
model District {
  id             String   @id @default(cuid())
  provinceId     String
  name           String   // Tên quận/huyện
  code           String?  // Mã quận/huyện
  type           Int?     // 1: Quận, 2: Huyện, 3: Thị xã, etc.
  
  // Provider IDs
  ghnId          Int?     @unique // GHN DistrictID
  ghtkId         String?  // GHTK district code
  vtpId          String?  // Viettel Post district ID
  supportType    Int?     // GHN support type (1,2,3)
  
  // Name variations
  nameExtensions String[]
  
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  
  province       Province @relation(fields: [provinceId], references: [id], onDelete: Cascade)
  wards          Ward[]
  
  @@index([provinceId])
  @@index([name])
  @@index([ghnId])
  @@map("addressify_districts")
  @@schema("public")
}

// Ward master data
model Ward {
  id             String   @id @default(cuid())
  districtId     String
  name           String   // Tên phường/xã
  
  // Provider IDs
  ghnCode        String?  @unique // GHN WardCode (string)
  ghtkId         String?  // GHTK ward code
  vtpId          String?  // Viettel Post ward ID
  supportType    Int?     // GHN support type
  canUpdateCOD   Boolean  @default(false)
  
  // Name variations
  nameExtensions String[]
  
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  
  district       District @relation(fields: [districtId], references: [id], onDelete: Cascade)
  
  @@index([districtId])
  @@index([name])
  @@index([ghnCode])
  @@map("addressify_wards")
  @@schema("public")
}

// Street master data (optional, for future use)
model Street {
  id             String   @id @default(cuid())
  wardId         String?  // Có thể null nếu đường chạy qua nhiều phường
  districtId     String
  name           String   // Tên đường
  
  // Name variations
  nameExtensions String[]
  
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  
  @@index([districtId])
  @@index([name])
  @@map("addressify_streets")
  @@schema("public")
}

// ==================== PROCESSED ADDRESS HISTORY ====================

// Processed address history - lưu lịch sử địa chỉ đã xử lý
model ProcessedAddress {
  id                String   @id @default(cuid())
  
  // Original input
  originalAddress   String   // Địa chỉ gốc người dùng nhập
  
  // Normalized components
  streetNumber      String?  // Số nhà
  streetName        String?  // Tên đường
  wardName          String?  // Tên phường/xã (đã chuẩn hóa)
  districtName      String?  // Tên quận/huyện (đã chuẩn hóa)
  provinceName      String?  // Tên tỉnh/thành phố (đã chuẩn hóa)
  
  // Full normalized address
  normalizedAddress String?  // Địa chỉ đầy đủ đã chuẩn hóa
  
  // Provider IDs (for quick lookup)
  ghnProvinceId     Int?
  ghnDistrictId     Int?
  ghnWardCode       String?
  
  // Matching confidence scores
  provinceConfidence Float?  // 0.0 - 1.0
  districtConfidence Float?
  wardConfidence     Float?
  
  // Validation
  isValid           Boolean  @default(false)
  validationErrors  String[] // Các lỗi nếu không hợp lệ
  
  // Metadata
  source            String?  // "manual", "bulk_upload", "api"
  userId            String?  // Người dùng xử lý (nếu có)
  
  createdAt         DateTime @default(now())
  
  @@index([originalAddress])
  @@index([provinceName, districtName, wardName])
  @@index([ghnProvinceId, ghnDistrictId])
  @@index([createdAt])
  @@index([userId])
  @@map("addressify_processed_addresses")
  @@schema("public")
}
